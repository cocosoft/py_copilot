groups:
  - name: py-copilot-api-alerts
    rules:
      - alert: HighAPILatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API响应时间过高"
          description: "95%分位响应时间超过500ms，当前值: {{ $value | printf \"%.3f\" }}s"

      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: error
        annotations:
          summary: "API错误率过高"
          description: "5xx错误率超过5%，当前值: {{ $value | printf \"%.2f\" }}%"

      - alert: APIDown
        expr: up{job="py-copilot-backend"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "后端API服务不可用"
          description: "后端API服务已停止响应"

  - name: py-copilot-resource-alerts
    rules:
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "CPU使用率过高"
          description: "CPU使用率超过80%，当前值: {{ $value | printf \"%.1f\" }}%"

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "内存使用率过高"
          description: "内存使用率超过85%，当前值: {{ $value | printf \"%.1f\" }}%"

      - alert: HighDiskUsage
        expr: (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100 > 90
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "磁盘使用率过高"
          description: "磁盘使用率超过90%，当前值: {{ $value | printf \"%.1f\" }}%"

  - py-copilot-business-alerts:
    rules:
      - alert: NoModelSelected
        expr: increase(default_model_selections_total[1h]) == 0
        for: 2h
        labels:
          severity: warning
        annotations:
          summary: "默认模型使用率异常"
          description: "过去2小时没有默认模型选择记录"

      - alert: HighModelSwitchRate
        expr: rate(default_model_changes_total[1h]) > 10
        for: 30m
        labels:
          severity: info
        annotations:
          summary: "模型切换频率过高"
          description: "模型切换频率超过10次/小时"

  - name: py-copilot-container-alerts
    rules:
      - alert: ContainerDown
        expr: container_last_seen > 0 and absent(container_start_time_seconds)
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "容器异常停止"
          description: "容器 {{ $labels.name }} 已停止运行"

      - alert: ContainerRestarting
        expr: changes(container_start_time_seconds[5m]) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "容器频繁重启"
          description: "容器 {{ $labels.name }} 在5分钟内重启超过3次"