# 模型开发专用计划

## 1. 项目概述

### 1.1 项目背景
本项目旨在构建一个完整的大语言模型管理系统，支持多供应商模型接入、管理和能力分类，为AI应用提供统一的模型服务接口和管理平台。系统将实现模型元数据管理、版本控制、能力标识、分类组织等核心功能，使开发者能够高效地管理和使用各类大语言模型。

### 1.2 主要目标
- 支持多供应商模型的统一管理和接入
- 提供模型能力和分类的结构化管理
- 实现模型版本控制和生命周期管理
- 建立模型性能监控和评估体系
- 为前端应用提供统一的模型服务API

### 1.3 技术栈
- 后端：Python FastAPI
- 数据库：SQLAlchemy ORM
- 前端：React
- API接口：RESTful + Async

## 2. 系统架构

### 2.1 整体架构
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    前端应用     │────▶│    后端API      │────▶│    数据库       │
│   (React)       │◀────│   (FastAPI)     │◀────│  (SQLAlchemy)   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                              │
                              ▼
                      ┌─────────────────┐
                      │   外部模型API   │
                      │  (OpenAI/DeepSeek等)│
                      └─────────────────┘
```

### 2.2 模块划分
- **供应商管理模块**：管理模型提供商信息、API配置
- **模型管理模块**：模型基础信息、参数配置、状态管理
- **能力管理模块**：模型能力定义与关联
- **分类管理模块**：模型分类树形结构管理
- **关联管理模块**：管理模型与能力、分类的关联关系

### 2.3 数据模型整合建议
- **统一模型定义**：解决项目中同一模型在多处定义的问题，建议采用模块中的完整定义
- **表名规范化**：统一表命名规范，避免混淆
- **字段一致性**：确保所有必要字段都正确定义，特别是时间戳和关联字段
- **关系定义统一**：使用一致的关系定义方式，避免冲突

## 3. 数据模型设计

### 3.1 核心数据模型

#### 3.1.1 模型供应商（suppliers表）
| 字段名 | 数据类型 | 描述 | 是否必填 |
|-------|---------|------|---------|
| id | Integer | 供应商ID（主键） | 是 |
| name | String | 供应商名称（如openai） | 是 |
| display_name | String | 显示名称（如OpenAI） | 否 |
| description | Text | 供应商描述 | 否 |
| api_endpoint | String | API端点URL | 否 |
| base_url | String | API基础URL | 否 |
| api_url | String | API完整URL | 否 |
| api_key | String | API密钥 | 否 |
| api_key_required | Boolean | 是否需要API密钥 | 否 |
| website | String | 官方网站 | 否 |
| api_docs | String | API文档地址 | 否 |
| category | String | 供应商分类 | 否 |
| logo | String | 供应商logo路径 | 否 |
| is_active | Boolean | 是否启用 | 是 |
| created_at | DateTime | 创建时间 | 否 |
| updated_at | DateTime | 更新时间 | 否 |

> 注：统一使用数据库中的suppliers表，删除ModelSupplier相关定义。

#### 3.1.2 模型（Model/ModelDB）
| 字段名 | 数据类型 | 描述 | 是否必填 |
|-------|---------|------|---------|
| id | Integer | 模型ID（主键） | 是 |
| name | String | 模型名称 | 是 |
| display_name | String | 显示名称 | 否 |
| description | Text | 模型描述 | 否 |
| supplier_id | Integer | 供应商ID（外键） | 是 |
| model_type | String | 模型类型（language/vision/multimodal/audio等） | 是 |
| sub_type | String | 子类型（如chat/completion/embedding/image_generation等） | 否 |
| is_default | Boolean | 是否为默认模型 | 否 |
| is_active | Boolean | 是否启用 | 是 |
| created_at | DateTime | 创建时间 | 否 |
| updated_at | DateTime | 更新时间 | 否 |

> 注：已移除NLP特定参数（context_window、max_tokens），转为使用通用的ModelParameter表存储不同类型模型的特定参数。

#### 3.1.3 模型参数（ModelParameters）
| 字段名 | 数据类型 | 描述 | 是否必填 |
|-------|---------|------|---------
| id | Integer | 参数ID（主键） | 是 |
| model_id | Integer | 模型ID（外键） | 是 |
| parameter_name | String | 参数名称 | 是 |
| parameter_type | String | 参数类型（int/float/bool/string/json等） | 是 |
| parameter_value | Text | 参数值（以文本形式存储） | 是 |
| is_default | Boolean | 是否为默认参数 | 否 |
| description | Text | 参数描述 | 否 |
| created_at | DateTime | 创建时间 | 否 |
| updated_at | DateTime | 更新时间 | 否 |

> 注：用于存储不同类型模型的特定参数，如NLP模型的context_window、temperature，视觉模型的resolution、aspect_ratio，多模态模型的max_tokens等。

> 注：基础模型中定义的ModelDB较为简单，模块中的Model定义更完整，建议统一使用模块中的定义。

#### 3.1.3 模型能力（ModelCapability/CapabilityDB）
| 字段名 | 数据类型 | 描述 | 是否必填 |
|-------|---------|------|---------|
| id | Integer | 能力ID（主键） | 是 |
| name | String | 能力名称（如text_generation, image_generation, speech_recognition） | 是 |
| display_name | String | 显示名称（如文本生成, 图像生成, 语音识别） | 是 |
| description | Text | 能力描述 | 否 |
| capability_type | String | 能力类型 | 否 |
| input_types | Text | 支持的输入类型（JSON格式），如["text", "image", "audio"] | 否 |
| output_types | Text | 支持的输出类型（JSON格式），如["text", "image", "audio"] | 否 |
| domain | String | 能力领域（nlp/cv/audio/multimodal） | 是 |
| is_active | Boolean | 是否启用 | 是 |
| created_at | DateTime | 创建时间 | 否 |
| updated_at | DateTime | 更新时间 | 否 |

> 注：项目中存在两个能力表定义，一个在基础模型中（capabilities表），一个在模块中（model_capabilities表），建议统一使用一个表结构。

#### 3.1.4 模型分类（ModelCategory）
| 字段名 | 数据类型 | 描述 | 是否必填 |
|-------|---------|------|---------|
| id | Integer | 分类ID（主键） | 是 |
| name | String | 分类名称（如llm, embedding, vision, multimodal） | 是 |
| display_name | String | 显示名称（如大语言模型, 嵌入模型, 视觉模型, 多模态模型） | 是 |
| description | Text | 分类描述 | 否 |
| category_type | String | 分类类型 | 是 |
| parent_id | Integer | 父分类ID | 否 |
| is_active | Boolean | 是否启用 | 是 |
| created_at | DateTime | 创建时间 | 否 |
| updated_at | DateTime | 更新时间 | 否 |

### 3.2 关联模型

#### 3.2.1 模型-能力关联（ModelCapabilityAssociation）
| 字段名 | 数据类型 | 描述 | 是否必填 |
|-------|---------|------|---------|
| id | Integer | 关联ID（主键） | 是 |
| model_id | Integer | 模型ID（外键） | 是 |
| capability_id | Integer | 能力ID（外键） | 是 |
| config | String | 简单配置（兼容旧系统） | 否 |
| config_json | Text | 扩展的JSON配置，支持复杂的能力配置，特别是多模态能力 | 否 |
| is_default | Boolean | 是否为默认能力配置 | 否 |
| created_at | DateTime | 创建时间 | 是 |
| updated_at | DateTime | 更新时间 | 否 |

#### 3.2.2 模型-分类关联（ModelCategoryAssociation）
| 字段名 | 数据类型 | 描述 | 是否必填 |
|-------|---------|------|---------|
| id | Integer | 关联ID（主键） | 是 |
| model_id | Integer | 模型ID（外键） | 是 |
| category_id | Integer | 分类ID（外键） | 是 |
| created_at | DateTime | 创建时间 | 是 |

### 3.3 数据库结构优化建议

1. **统一模型定义**：
   - 清理重复的模型定义，保留模块中的完整定义
   - 删除基础模型中过时的简单定义，避免冲突

2. **表名规范化**：
   - 供应商表：统一使用`suppliers`表
   - 能力表：统一使用`model_capabilities`或`capabilities`
   - 确保所有表名遵循一致的命名规范

3. **多模态模型支持**：
   - 重构ModelDB表，移除NLP特定参数，使用通用字段model_type和sub_type支持不同类型模型
   - 创建ModelParameter表存储各类模型的特定参数，实现参数的灵活配置
   - 扩展ModelCapability表，添加input_types、output_types和domain字段支持多模态能力
   - 增强ModelCapabilityAssociation表，添加config_json字段支持复杂配置

4. **字段调整**：
   - 统一时间戳字段类型（DateTime而非String）
   - 确保所有关联字段使用正确的外键约束
   - 移除冗余字段，合并相似功能的字段

5. **数据库初始化优化**：
   - 完善`init_db.py`脚本，确保正确初始化所有表
   - 添加数据迁移策略，避免数据丢失

6. **关系定义优化**：
   - 统一使用SQLAlchemy关系定义方式
   - 确保`backref`和`back_populates`使用一致

7. **分类体系扩展**：
   - 扩展ModelCategory表，增加对视觉模型、多模态模型的分类支持
   - 增强树形结构管理，支持更复杂的分类层次关系

## 4. API设计

### 4.1 供应商管理API

#### 4.1.1 获取供应商列表
- **路径**: `/api/v1/suppliers`
- **方法**: `GET`
- **响应**: `SupplierListResponse`

#### 4.1.2 创建供应商
- **路径**: `/api/v1/suppliers`
- **方法**: `POST`
- **请求体**: `SupplierCreate`
- **响应**: `SupplierResponse`

#### 4.1.3 更新供应商
- **路径**: `/api/v1/suppliers/{supplier_id}`
- **方法**: `PUT`
- **请求体**: `SupplierUpdate`
- **响应**: `SupplierResponse`

### 4.2 模型管理API

#### 4.2.1 获取模型列表
- **路径**: `/api/v1/models`
- **方法**: `GET`
- **响应**: `ModelListResponse`

#### 4.2.2 创建模型
- **路径**: `/api/v1/models`
- **方法**: `POST`
- **请求体**: `ModelCreate`
- **响应**: `ModelResponse`

#### 4.2.3 设置默认模型
- **路径**: `/api/v1/models/set-default`
- **方法**: `POST`
- **请求体**: `SetDefaultModelRequest`
- **响应**: `ModelResponse`

### 4.3 能力管理API

#### 4.3.1 获取能力列表
- **路径**: `/api/v1/capabilities`
- **方法**: `GET`
- **响应**: `ModelCapabilityListResponse`

#### 4.3.2 创建能力
- **路径**: `/api/v1/capabilities`
- **方法**: `POST`
- **请求体**: `ModelCapabilityCreate`
- **响应**: `ModelCapabilityResponse`

#### 4.3.3 关联模型与能力
- **路径**: `/api/v1/capabilities/associations`
- **方法**: `POST`
- **请求体**: `ModelCapabilityAssociationCreate`
- **响应**: `ModelCapabilityAssociationResponse`

### 4.4 分类管理API

#### 4.4.1 获取分类列表（树形结构）
- **路径**: `/api/v1/categories/tree`
- **方法**: `GET`
- **响应**: `List[ModelCategoryWithChildrenResponse]`

#### 4.4.2 创建分类
- **路径**: `/api/v1/categories`
- **方法**: `POST`
- **请求体**: `ModelCategoryCreate`
- **响应**: `ModelCategoryResponse`

#### 4.4.3 关联模型与分类
- **路径**: `/api/v1/categories/associations`
- **方法**: `POST`
- **请求体**: `ModelCategoryAssociationCreate`
- **响应**: `ModelCategoryAssociationResponse`

## 5. 开发路线图

### 5.1 第一阶段：基础架构搭建（2周）
- 数据库模型设计和迁移脚本创建
- FastAPI应用初始化和基础配置
- 数据库连接和会话管理
- 项目目录结构优化

### 5.2 第二阶段：核心功能开发（3周）
- 供应商管理模块开发
- 模型管理模块开发
- 基础API接口实现
- 数据验证和错误处理

### 5.3 第三阶段：能力与分类管理（2周）
- 模型能力管理模块开发
- 模型分类管理模块开发
- 关联管理功能实现
- 树形分类结构支持

### 5.4 第四阶段：前端集成与测试（3周）
- 前端页面开发和组件实现
- API接口集成和联调
- 单元测试和集成测试
- 性能优化和安全性检查

### 5.5 第五阶段：系统上线与部署（1周）
- 系统部署和环境配置
- 数据初始化和导入
- 上线前最终测试
- 文档完善和知识交接

## 6. 实施建议

### 6.1 数据管理最佳实践
- 采用软删除策略，避免直接删除记录
- 使用数据库事务确保数据一致性
- 实现数据验证层，防止非法数据写入
- 建立数据备份和恢复机制

### 6.2 开发规范
- 遵循RESTful API设计原则
- 使用Pydantic进行数据验证
- 实现统一的异常处理机制
- 编写完整的API文档
- 遵循PEP 8编码规范

### 6.3 性能优化
- 为常用查询字段建立索引
- 优化数据库查询，避免N+1问题
- 使用连接池管理数据库连接
- 实现API响应缓存机制

### 6.4 安全性考虑
- 实现API认证和授权机制
- 加密存储敏感信息（如API密钥）
- 防止SQL注入和XSS攻击
- 实施请求频率限制

## 7. 未来扩展方向

### 7.1 功能扩展
- 模型性能监控和日志分析
- 模型版本控制和回滚机制
- 模型比较和推荐功能
- 自动化模型评估工具

### 7.2 集成能力
- 支持更多模型供应商
- 集成模型微调功能
- 实现模型部署和服务化
- 支持多模态模型管理

### 7.3 高级特性
- A/B测试框架
- 模型成本分析和优化
- 智能路由和负载均衡
- 模型资源调度和管理

## 8. 风险评估与应对策略

### 8.1 技术风险
- **风险**：不同供应商API兼容性问题
  **应对**：实现适配器模式，统一API调用接口

- **风险**：数据库性能随数据量增长下降
  **应对**：实施数据库分片和读写分离

### 8.2 业务风险
- **风险**：模型更新导致服务不稳定
  **应对**：实现灰度发布和快速回滚机制

- **风险**：API密钥管理安全隐患
  **应对**：使用密钥管理服务，定期轮换密钥

### 8.3 项目风险
- **风险**：需求变更影响开发进度
  **应对**：采用敏捷开发方法，定期进行需求评审

- **风险**：团队协作效率低下
  **应对**：建立清晰的任务分配和代码审查机制

---

*本计划将根据项目进展和需求变化进行动态调整，各阶段目标可根据实际情况进行优先级排序和资源分配。*